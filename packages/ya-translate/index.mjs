/* eslint-disable */
import t from"node:os";import e from"node:fs";import r from"node:path";import a from"node:child_process";import n from"node-fetch";var o,i,s,c,l,y,h,f,d,u,g,p,m="https://translate.api.cloud.yandex.net/translate/v2/detect",w="https://translate.api.cloud.yandex.net/translate/v2/languages",S="https://translate.api.cloud.yandex.net/translate/v2/translate",x=396e5,v=()=>i="",A=()=>{if(!i){var t=!1;if(e.existsSync(l)){var r=e.lstatSync(c).mtimeMs,n=Date.now()-r;n>3564e4?t=!0:setTimeout(v,x-n)}else t=!0;t?(i=a.execSync("yc iam create-token",{encoding:"utf8"}).trim(),e.writeFileSync(l,i),setTimeout(v,x)):i=e.readFileSync(l,"utf8").trim(),console.log("YA_API_TOKEN: ",i)}},O=()=>N(w),j=async(t,e)=>{if(!(t=t.trim().slice(0,990).toLocaleLowerCase()))throw new Error("YA detectLanguage: text is empty");return N(m,t,e)},F=async(t,e,r)=>{if(!e)throw new Error("YA translate: from is empty");if(!r)throw new Error("YA translate: to is empty");var a=Array.isArray(t);if(e===r||!t.length)return a?t.slice(0):t;var n=(a?t:[t]).reduce(((t,e)=>{if(e.length>9990)throw new Error("YA translate: text very big");var r=t[t.length-1];return e.length+r.join("").length>9990?t.push([e]):r.push(e),t}),[[]]),o=await Promise.all(n.map((function(t){return N(S,t,this.from,this.to)}),{from:e,to:r}));return a?Array.prototype.concat.apply([],o):o[0][0]||""},P=[];function N(t,e,r,a){return new Promise(((n,o)=>{P.push({resolve:n,reject:o,URL:t,text:e,from:r,to:a}),C()}))}async function C(){if(!p&&(p=P.shift())){(()=>{if(!o){s=t.homedir(),c=r.resolve(s,".ya.folder_id.cache.txt"),l=r.resolve(s,".ya.api_token.cache.txt"),y=r.resolve(s,".ya.languages.cache.json"),h=r.resolve(s,".ya.translate.cache.json"),f=r.resolve(s,".ya.detection.cache.json");try{if(e.existsSync(c))o=e.readFileSync(c,"utf8").trim();else{var n=a.execSync("yc config list",{encoding:"utf8"});o=n.match(/folder-id:\s*([^\s]+)/)[1].trim(),e.writeFileSync(c,o)}console.log("YA_FOLDER_ID: ",o)}catch(i){throw{myMsg:'Please install "yc" cli: https://yandex.cloud/ru/docs/cli/quickstart',error:i}}try{e.existsSync(y)&&(g=e.readFileSync(y,"utf8")||"")}catch(p){}d={};try{e.existsSync(h)&&(d=JSON.parse(e.readFileSync(h,"utf8"))||{})}catch(m){}u={};try{e.existsSync(f)&&(u=JSON.parse(e.readFileSync(f,"utf8"))||{})}catch(w){}}})();var x=p,v=x.resolve,O=x.reject;try{switch(p.URL){case w:if(g)v(JSON.parse(g).languages);else{A();var j={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({folderId:o})},F=await n(w,j),N=await F.text(),J=JSON.parse(N);if(!Array.isArray(J.languages))throw J;e.writeFileSync(y,g=N),v(J.languages)}break;case m:var L=p.text;if(!u.hasOwnProperty(L)){A();var T={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({text:L,languageCodeHints:p.from,folderId:o})},Y=await n(m,T),E=await Y.json();if("string"!=typeof E.languageCode)throw E;u[L]=E.languageCode,console.log("YA detectLanguage: "+L+" => "+u[L]),e.writeFileSync(f,JSON.stringify(u,null,2))}v(u[L]);break;case S:var _=p,b=_.text,k=_.from,I=_.to;d.hasOwnProperty(k)||(d[k]={}),d[k].hasOwnProperty(I)||(d[k][I]={});var z=b.filter((function(t,e,r){return t.trim()&&!this.hasOwnProperty(t)&&e===r.indexOf(t)}),d[k][I]),B=d[k][I];if(z.length){A();var D={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({sourceLanguageCode:k,targetLanguageCode:I,texts:z,folderId:o})},R=await n(S,D),$=await R.json();if(!Array.isArray($.translations))throw $;$.translations.forEach((function(t,e){console.log("YA translate "+this.to+": "+this.texts[e]+" => "+t.text),this.data[this.texts[e]]=t.text}),{data:B,texts:z,to:I}),e.writeFileSync(h,JSON.stringify(d,null,2))}v(b.map((function(t){return this[t]}),B))}}catch(M){O(M)}p=null,C()}}export{j as detectLanguage,O as listLanguages,F as translate};
