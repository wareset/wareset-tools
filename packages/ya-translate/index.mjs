/* eslint-disable */
import t from"node:os";import e from"node:fs";import r from"node:path";import a from"node:child_process";import n from"node-fetch";var o,i,s,c,l,y,h,f,d,u,g,p,m="https://translate.api.cloud.yandex.net/translate/v2/detect",w="https://translate.api.cloud.yandex.net/translate/v2/languages",S="https://translate.api.cloud.yandex.net/translate/v2/translate",x=396e5,v=()=>i="",A=()=>{if(!o){s=t.homedir(),c=r.resolve(s,".ya.folder_id.cache.txt"),l=r.resolve(s,".ya.api_token.cache.txt"),y=r.resolve(s,".ya.languages.cache.json"),h=r.resolve(s,".ya.translate.cache.json"),f=r.resolve(s,".ya.detection.cache.json");try{if(e.existsSync(c))o=e.readFileSync(c,"utf8").trim();else{var n=a.execSync("yc config list",{encoding:"utf8"});o=n.match(/folder-id:\s*([^\s]+)/)[1].trim(),e.writeFileSync(c,o)}console.log("YA_FOLDER_ID: ",o)}catch(i){throw{myMsg:'Please install "yc" cli: https://yandex.cloud/ru/docs/cli/quickstart',error:i}}try{e.existsSync(y)&&(g=e.readFileSync(y,"utf8")||"")}catch(p){}d={};try{e.existsSync(h)&&(d=JSON.parse(e.readFileSync(h,"utf8"))||{})}catch(m){}u={};try{e.existsSync(f)&&(u=JSON.parse(e.readFileSync(f,"utf8"))||{})}catch(w){}}},O=()=>{if(!i){var t=!1;if(e.existsSync(l)){var r=e.lstatSync(c).mtimeMs,n=Date.now()-r;n>3564e4?t=!0:setTimeout(v,x-n)}else t=!0;t?(i=a.execSync("yc iam create-token",{encoding:"utf8"}).trim(),e.writeFileSync(l,i),setTimeout(v,x)):i=e.readFileSync(l,"utf8").trim(),console.log("YA_API_TOKEN: ",i)}},j=()=>C(w),F=async(t,e)=>{if(!(t=t.trim().slice(0,990).toLocaleLowerCase()))throw new Error("YA detectLanguage: text is empty");return C(m,t,e)},P=async(t,e,r)=>{if(!e)throw new Error("YA translate: from is empty");if(!r)throw new Error("YA translate: to is empty");var a=Array.isArray(t);if(e===r||!t.length)return a?t.slice(0):t;var n=(a?t:[t]).reduce(((t,e)=>{if(e.length>9990)throw new Error("YA translate: text very big");var r=t[t.length-1];return e.length+r.join("").length>9990?t.push([e]):r.push(e),t}),[[]]),o=await Promise.all(n.map((function(t){return C(S,t,this.from,this.to)}),{from:e,to:r}));return a?Array.prototype.concat.apply([],o):o[0][0]||""},N=[];function C(t,e,r,a){return new Promise(((n,o)=>{N.push({resolve:n,reject:o,URL:t,text:e,from:r,to:a}),J()}))}async function J(){if(!p&&(p=N.shift())){A();var t=p,r=t.resolve,a=t.reject;try{switch(p.URL){case w:if(g)r(JSON.parse(g).languages);else{O();var s={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({folderId:o})},c=await n(w,s),l=await c.text(),x=JSON.parse(l);if(!Array.isArray(x.languages))throw x;e.writeFileSync(y,g=l),r(x.languages)}break;case m:var v=p.text;if(!u.hasOwnProperty(v)){O();var j={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({text:v,languageCodeHints:p.from,folderId:o})},F=await n(m,j),P=await F.json();if("string"!=typeof P.languageCode)throw P;u[v]=P.languageCode,console.log("YA detectLanguage: "+v+" => "+u[v]),e.writeFileSync(f,JSON.stringify(u,null,2))}r(u[v]);break;case S:var C=p,L=C.text,T=C.from,Y=C.to;d.hasOwnProperty(T)||(d[T]={}),d[T].hasOwnProperty(Y)||(d[T][Y]={});var E=L.filter((function(t,e,r){return t.trim()&&!this.hasOwnProperty(t)&&e===r.indexOf(t)}),d[T][Y]),_=d[T][Y];if(E.length){O();var b={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({sourceLanguageCode:T,targetLanguageCode:Y,texts:E,folderId:o})},k=await n(S,b),I=await k.json();if(!Array.isArray(I.translations))throw I;I.translations.forEach((function(t,e){console.log("YA translate "+this.to+": "+this.texts[e]+" => "+t.text),this.data[this.texts[e]]=t.text}),{data:_,texts:E,to:Y}),e.writeFileSync(h,JSON.stringify(d,null,2))}r(L.map((function(t){return this[t]}),_))}}catch(z){a(z)}p=null,J()}}export{F as detectLanguage,j as listLanguages,P as translate};
