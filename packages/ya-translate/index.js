/* eslint-disable */
const e=require("node:os"),t=require("node:fs"),r=require("node:path"),a=require("node:child_process"),n=require("node-fetch");var s,i,o,c,l,y,h,u,d,f,g,p,w="https://translate.api.cloud.yandex.net/translate/v2/detect",m="https://translate.api.cloud.yandex.net/translate/v2/languages",x="https://translate.api.cloud.yandex.net/translate/v2/translate",S=396e5,v=()=>i="",A=()=>{if(!i){var e=!1;if(t.existsSync(l)){var r=t.lstatSync(c).mtimeMs,n=Date.now()-r;n>3564e4?e=!0:setTimeout(v,S-n)}else e=!0;e?(i=a.execSync("yc iam create-token",{encoding:"utf8"}).trim(),t.writeFileSync(l,i),setTimeout(v,S)):i=t.readFileSync(l,"utf8").trim(),console.log("YA_API_TOKEN: ",i)}},O=[];function j(e,t,r,a){return new Promise(((n,s)=>{O.push({resolve:n,reject:s,URL:e,text:t,from:r,to:a}),F()}))}async function F(){if(!p&&(p=O.shift())){(()=>{if(!s){o=e.homedir(),c=r.resolve(o,".ya.folder_id.cache.txt"),l=r.resolve(o,".ya.api_token.cache.txt"),y=r.resolve(o,".ya.languages.cache.json"),h=r.resolve(o,".ya.translate.cache.json"),u=r.resolve(o,".ya.detection.cache.json");try{if(t.existsSync(c))s=t.readFileSync(c,"utf8").trim();else{var n=a.execSync("yc config list",{encoding:"utf8"});s=n.match(/folder-id:\s*([^\s]+)/)[1].trim(),t.writeFileSync(c,s)}console.log("YA_FOLDER_ID: ",s)}catch(i){throw{myMsg:'Please install "yc" cli: https://yandex.cloud/ru/docs/cli/quickstart',error:i}}try{t.existsSync(y)&&(g=t.readFileSync(y,"utf8")||"")}catch(p){}d={};try{t.existsSync(h)&&(d=JSON.parse(t.readFileSync(h,"utf8"))||{})}catch(w){}f={};try{t.existsSync(u)&&(f=JSON.parse(t.readFileSync(u,"utf8"))||{})}catch(m){}}})();var S=p,v=S.resolve,j=S.reject;try{switch(p.URL){case m:if(g)v(JSON.parse(g).languages);else{A();var L={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({folderId:s})},P=await n(m,L),N=await P.text(),C=JSON.parse(N);if(!Array.isArray(C.languages))throw C;t.writeFileSync(y,g=N),v(C.languages)}break;case w:var J=p.text;if(!f.hasOwnProperty(J)){A();var T={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({text:J,languageCodeHints:p.from,folderId:s})},Y=await n(w,T),E=await Y.json();if("string"!=typeof E.languageCode)throw E;f[J]=E.languageCode,console.log("YA detectLanguage: "+J+" => "+f[J]),t.writeFileSync(u,JSON.stringify(f,null,2))}v(f[J]);break;case x:var _=p,b=_.text,q=_.from,k=_.to;d.hasOwnProperty(q)||(d[q]={}),d[q].hasOwnProperty(k)||(d[q][k]={});var I=b.filter((function(e,t,r){return e.trim()&&!this.hasOwnProperty(e)&&t===r.indexOf(e)}),d[q][k]),z=d[q][k];if(I.length){A();var B={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({sourceLanguageCode:q,targetLanguageCode:k,texts:I,folderId:s})},D=await n(x,B),R=await D.json();if(!Array.isArray(R.translations))throw R;R.translations.forEach((function(e,t){console.log("YA translate "+this.to+": "+this.texts[t]+" => "+e.text),this.data[this.texts[t]]=e.text}),{data:z,texts:I,to:k}),t.writeFileSync(h,JSON.stringify(d,null,2))}v(b.map((function(e){return this[e]}),z))}}catch($){j($)}p=null,F()}}exports.detectLanguage=async(e,t)=>{if(!(e=e.trim().slice(0,990).toLocaleLowerCase()))throw new Error("YA detectLanguage: text is empty");return j(w,e,t)},exports.listLanguages=()=>j(m),exports.translate=async(e,t,r)=>{if(!t)throw new Error("YA translate: from is empty");if(!r)throw new Error("YA translate: to is empty");var a=Array.isArray(e);if(t===r||!e.length)return a?e.slice(0):e;var n=(a?e:[e]).reduce(((e,t)=>{if(t.length>9990)throw new Error("YA translate: text very big");var r=e[e.length-1];return t.length+r.join("").length>9990?e.push([t]):r.push(t),e}),[[]]),s=await Promise.all(n.map((function(e){return j(x,e,this.from,this.to)}),{from:t,to:r}));return a?Array.prototype.concat.apply([],s):s[0][0]||""};
